name: CI

on:
  pull_request:
  push:
    branches: [master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libffi-dev libz-dev libxml2-dev zlib1g-dev
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20 all
          sudo apt-get install -y libpolly-20-dev llvm-20-dev
          echo "/usr/lib/llvm-20/bin" >> $GITHUB_PATH
          echo "LLVM_SYS_201_PREFIX=/usr/lib/llvm-20" >> $GITHUB_ENV

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.0
          cache: true

      - name: Install nightly Rust (for secondlang)
        run: rustup toolchain install nightly

      - name: Format Check
        run: pixi run format-check

      - name: Clippy (stable)
        run: pixi run clippy

      - name: Clippy Secondlang (nightly)
        run: pixi run clippy-secondlang

      - name: Build (stable)
        run: pixi run build

      - name: Build Secondlang (nightly)
        run: pixi run build-secondlang

      - name: Test Calculator
        run: pixi run test-calculator

      - name: Test Firstlang
        run: pixi run test-firstlang

      - name: Test Secondlang
        run: pixi run test-secondlang

      - name: Run Examples
        run: pixi run examples

      - name: Build Book
        run: pixi run book-build
