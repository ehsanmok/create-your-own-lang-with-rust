<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Read-Eval-Print Loop (REPL) - Create Your Own Programming Language with Rust</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom.css">
        <link rel="stylesheet" href="../theme/highlight.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Create Your Own Programming Language with Rust</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/ehsanmok/create-your-own-lang-with-rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="read-eval-print-loop-repl"><a class="header" href="#read-eval-print-loop-repl">Read-Eval-Print Loop (REPL)</a></h2>
<p>A REPL is an interactive programming environment. You type code, it immediately runs, you see the result. Then you type more code. This tight feedback loop makes REPLs perfect for learning, experimenting, and debugging.</p>
<p>You’ve probably used REPLs before:</p>
<ul>
<li>Python’s <code>&gt;&gt;&gt;</code> prompt</li>
<li>Node.js’s interactive mode</li>
<li>Browser developer console</li>
</ul>
<p>Now we’ll build one for our calculator! Even better, we’ll be able to switch between three execution backends - seeing how the same code runs through different compilation paths.</p>
<h3 id="how-a-repl-works"><a class="header" href="#how-a-repl-works">How a REPL Works</a></h3>
<p>The name tells you everything:</p>
<ol>
<li><strong>Read</strong> - Get a line of input from the user</li>
<li><strong>Eval</strong> - Parse and execute it</li>
<li><strong>Print</strong> - Show the result</li>
<li><strong>Loop</strong> - Go back to step 1</li>
</ol>
<p>Here’s our implementation using <a href="https://github.com/kkawakam/rustyline">rustyline</a>, a library that provides readline-style line editing (arrow keys, history, etc.):</p>
<pre><code class="language-rust no_run noplaypen">fn main() -&gt; Result&lt;()&gt; {
    let mut rl = DefaultEditor::new()?;
    println!("Calculator prompt. Expressions are line evaluated.");
    loop {
        let readline = rl.readline("&gt;&gt; ");
        match readline {
            Ok(line) =&gt; {
                let line = line.trim();
                if line.is_empty() {
                    continue;
                }
                cfg_if! {
                    if #[cfg(any(feature = "jit", feature = "interpreter"))] {
                        match Engine::from_source(line) {
                            Ok(result) =&gt; println!("{}", result),
                            Err(e) =&gt; eprintln!("{}", e),
                        };
                    }
                    else if #[cfg(feature = "vm")] {
                        let byte_code = Engine::from_source(line);
                        println!("byte code: {:?}", byte_code);
                        let mut vm = VM::new(byte_code);
                        vm.run();
                        println!("{}", vm.pop_last());
                    }
                }
            }
            Err(ReadlineError::Interrupted) =&gt; {
                println!("CTRL-C");
                break;
            }
            Err(ReadlineError::Eof) =&gt; {
                println!("CTRL-D");
                break;
            }
            Err(err) =&gt; {
                println!("Error: {:?}", err);
                break;
            }
        }
    }
    Ok(())</code></pre>
<p><a class="filename" href="https://github.com/ehsanmok/create-your-own-lang-with-rust/blob/master/calculator/src/bin/repl.rs">calculator/src/bin/repl.rs</a></p>
<p>The REPL is simple:</p>
<ol>
<li>Create a rustyline editor (handles input, history, etc.)</li>
<li>Loop forever, reading lines</li>
<li>For each line, compile and execute using the chosen backend</li>
<li>Print the result</li>
<li>On Ctrl-C or Ctrl-D, exit</li>
</ol>
<h3 id="three-backends-one-interface"><a class="header" href="#three-backends-one-interface">Three Backends, One Interface</a></h3>
<p>It’s all controlled by feature flags. The same REPL works with three different backends:</p>
<div class="table-wrapper"><table><thead><tr><th>Backend</th><th>Description</th><th>Rust Version</th></tr></thead><tbody>
<tr><td><strong>Interpreter</strong></td><td>Walks AST directly</td><td>Stable</td></tr>
<tr><td><strong>VM</strong></td><td>Compiles to bytecode</td><td>Stable</td></tr>
<tr><td><strong>JIT</strong></td><td>Compiles to native code via LLVM</td><td>Nightly</td></tr>
</tbody></table>
</div>
<p>You can compare how the same expression is handled by each backend. Let’s run through two examples with all three.</p>
<h3 id="interpreter-output-example"><a class="header" href="#interpreter-output-example">Interpreter Output Example</a></h3>
<p>The interpreter walks the AST and computes results directly:</p>
<pre><code class="language-bash">cargo run --bin repl --features interpreter
</code></pre>
<p>You see the AST structure and direct evaluation:</p>
<pre><code class="language-text">Calculator prompt. Expressions are line evaluated.
&gt;&gt; 1 + 2
Compiling the source: 1 + 2
[BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }]
3
</code></pre>
<p>The interpreter is the simplest backend. It parses the input into an AST (<code>BinaryExpr</code> with <code>Plus</code> operator, left-hand side <code>Int(1)</code>, right-hand side <code>Int(2)</code>), then walks the tree and computes the result directly.</p>
<p>A more complex expression shows a nested AST:</p>
<pre><code class="language-text">&gt;&gt; (1 + 2) - (8 - 10)
Compiling the source: (1 + 2) - (8 - 10)
[BinaryExpr { op: Minus, lhs: BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }, rhs: BinaryExpr { op: Minus, lhs: Int(8), rhs: Int(10) } }]
5
</code></pre>
<p>The outer <code>BinaryExpr</code> has <code>Minus</code> as its operator, with two inner <code>BinaryExpr</code> nodes as children. The interpreter recursively evaluates each subtree: <code>(1 + 2) = 3</code>, <code>(8 - 10) = -2</code>, then <code>3 - (-2) = 5</code>.</p>
<h3 id="vm-output-example"><a class="header" href="#vm-output-example">VM Output Example</a></h3>
<p>The VM compiles AST to bytecode, then executes it on a stack machine:</p>
<pre><code class="language-bash">cargo run --bin repl --no-default-features --features vm
</code></pre>
<p>You see bytecode generation step by step:</p>
<pre><code class="language-text">Calculator prompt. Expressions are line evaluated.
&gt;&gt; 1 + 2
Compiling the source: 1 + 2
[BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }]
compiling node BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }
added instructions [1, 0, 0] from opcode OpConstant(0)
added instructions [1, 0, 0, 1, 0, 1] from opcode OpConstant(1)
added instructions [1, 0, 0, 1, 0, 1, 3] from opcode OpAdd
added instructions [1, 0, 0, 1, 0, 1, 3, 2] from opcode OpPop
byte code: Bytecode { instructions: [1, 0, 0, 1, 0, 1, 3, 2], constants: [Int(1), Int(2)] }
3
</code></pre>
<p>Instead of walking the tree directly, the VM compiles the AST to bytecode first. You can see each instruction being added:</p>
<ol>
<li><code>OpConstant(0)</code> - Push constant at index 0 (which is <code>1</code>)</li>
<li><code>OpConstant(1)</code> - Push constant at index 1 (which is <code>2</code>)</li>
<li><code>OpAdd</code> - Pop two values, push their sum</li>
<li><code>OpPop</code> - Pop and return the result</li>
</ol>
<p>A more complex expression shows more bytecode instructions being generated:</p>
<pre><code class="language-text">&gt;&gt; (1 + 2) - (8 - 10)
Compiling the source: (1 + 2) - (8 - 10)
[BinaryExpr { op: Minus, lhs: BinaryExpr { ... }, rhs: BinaryExpr { ... } }]
compiling node BinaryExpr { ... }
added instructions [1, 0, 0] from opcode OpConstant(0)
added instructions [1, 0, 0, 1, 0, 1] from opcode OpConstant(1)
added instructions [1, 0, 0, 1, 0, 1, 3] from opcode OpAdd
added instructions [1, 0, 0, 1, 0, 1, 3, 1, 0, 2] from opcode OpConstant(2)
added instructions [1, 0, 0, 1, 0, 1, 3, 1, 0, 2, 1, 0, 3] from opcode OpConstant(3)
added instructions [1, 0, 0, 1, 0, 1, 3, 1, 0, 2, 1, 0, 3, 4] from opcode OpSub
added instructions [1, 0, 0, 1, 0, 1, 3, 1, 0, 2, 1, 0, 3, 4, 4] from opcode OpSub
added instructions [1, 0, 0, 1, 0, 1, 3, 1, 0, 2, 1, 0, 3, 4, 4, 2] from opcode OpPop
byte code: Bytecode { instructions: [1, 0, 0, 1, 0, 1, 3, 1, 0, 2, 1, 0, 3, 4, 4, 2], constants: [Int(1), Int(2), Int(8), Int(10)] }
5
</code></pre>
<p>Four constants, multiple operations, all encoded in a flat byte array. The VM then executes this bytecode using a simple stack machine.</p>
<h3 id="jit-output-example"><a class="header" href="#jit-output-example">JIT Output Example</a></h3>
<p>The JIT compiles to native machine code via LLVM (requires nightly Rust):</p>
<pre><code class="language-bash">rustup run nightly cargo run --bin repl --no-default-features --features jit
</code></pre>
<p>You see the generated LLVM IR:</p>
<pre><code class="language-text">Calculator prompt. Expressions are line evaluated.
&gt;&gt; 1 + 2
Compiling the source: 1 + 2
[BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }]
Generated LLVM IR: define i32 @jit() {
entry:
  ret i32 3
}

3
</code></pre>
<p>Notice something interesting: the IR just says <code>ret i32 3</code>! LLVM computed <code>1 + 2 = 3</code> at compile time and baked the answer directly into the code. This is <strong>constant folding</strong>, one of LLVM’s many optimizations.</p>
<p>Let’s try the same complex expression:</p>
<pre><code class="language-text">&gt;&gt; (1 + 2) - (8 - 10)
Compiling the source: (1 + 2) - (8 - 10)
[BinaryExpr { op: Minus, lhs: BinaryExpr { op: Plus, lhs: Int(1), rhs: Int(2) }, rhs: BinaryExpr { op: Minus, lhs: Int(8), rhs: Int(10) } }]
Generated LLVM IR: define i32 @jit() {
entry:
  ret i32 5
}

5
</code></pre>
<p>Again, LLVM optimized the whole expression to just <code>ret i32 5</code>. The AST shows the full nested structure, but the compiled native code is minimal - just returning a constant!</p>
<h3 id="why-build-a-repl"><a class="header" href="#why-build-a-repl">Why Build a REPL?</a></h3>
<p>Building a REPL teaches you:</p>
<ol>
<li><strong>The edit-compile-run cycle</strong> - Even simpler than files</li>
<li><strong>Error handling</strong> - What happens when input is invalid?</li>
<li><strong>State management</strong> - In later chapters, we’ll maintain variables across lines</li>
<li><strong>Debugging</strong> - Print AST, bytecode, or IR to see what’s happening</li>
</ol>
<p>Professional language implementations always include a REPL. It’s one of the most useful tools for both language developers and language users.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>This concludes our <a href="./calc_intro.html">Calculator</a> chapter. We took advantage of the simplicity of our <code>Calc</code> language to cover a lot of ground:</p>
<ul>
<li><strong>Grammar and parsing</strong> - Converting text to structured data</li>
<li><strong>AST</strong> - Representing programs as trees</li>
<li><strong>Interpretation</strong> - Walking the tree and computing</li>
<li><strong>JIT compilation</strong> - Generating native code with LLVM</li>
<li><strong>Bytecode VMs</strong> - An intermediate approach</li>
<li><strong>REPL</strong> - Interactive programming</li>
</ul>
<p>Note that our Calculator grammar is intentionally simple. It handles basic cases like negative first numbers (<code>-1 + 2</code>) and flexible whitespace, but it doesn’t have proper operator precedence. The expression <code>1 + 2 * 3</code> might not evaluate as you’d expect! In the next chapter, we’ll see how <a href="../02_firstlang/intro.html">Firstlang</a> builds a more sophisticated grammar with proper operator precedence and multiple expression types.</p>
<p>Thanks for following along! In the next chapter, we’ll build <strong>Firstlang</strong> - a dynamically typed language with variables, functions, control flow, and recursion.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../01_calculator/vm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../01_calculator/debugging.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../01_calculator/vm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../01_calculator/debugging.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/force-theme.js"></script>



    </div>
    </body>
</html>
